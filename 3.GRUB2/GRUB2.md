# GRUB2

## 什么是GRUB2

GRUB 2 是 Ubuntu 的默认引导加载程序和管理器。 当在计算机中安装了双系统时，启动时经常会看到如下的界面

而按下键盘上的C键则会进入如下的命令行界面。

![IMG_6540](../../Documents/Tencent%20Files/614567188/FileRecv/MobileFile/IMG_6540.JPG)

当计算机启动时，GRUB 2 要么显示一个菜单并等待用户输入，要么自动将控制权转移到操作系统内核。 GRUB 2 是 GRUB（GRand Unified Bootloader）的后代。 它已被完全重写，为用户提供显着提高的灵活性和性能。

## 配置GRUB2

通常情况下对GRUB2的配置的更改应在写在``/etc/default/grub``文件中。此外，如果不以管理员的身份运行``update-grub``命令的话，grub的配置不会发生任何更改。这条命令运行了GRUB2的配置脚本，并更新``/boot/grub/grub.cfg`` 文件。

如果除了优麒麟外没有其他的操作系统被检测到，GRUB2会直接进入默认的操作系统并且不显示任何的选择菜单；反之如果监测到了其他的系统，GRUB2会显示如上图所示的默认选择菜单。需要注意的是GRUB2的显示菜单并不会一直显示。一般来说会显示指定的时间，如8秒左右。默认选择项在菜单中被高亮出来。如果直到时间耗尽还是没有任何用户输入的话（按下方向键，按下Enter键等），那么GRUB2会进入默认的系统。而一旦有按键被按下，时间限制则会取消，GRUB2会挂载不动，直到Enter键被按下（意味着用户选择进入了某个系统）。

默认启动项位于``/etc/default/grub``文件中的``GRUB_DEFAULT``字段。

## GRUB2配置文件修复

当我们在某些情况下误操作了``/boot/grub/grub.conf``，或者一些关键配置出了问题，或者MBR（关于什么是MBR可以参见上一篇文章）的引导程序遭到了破坏，主机启动之后可能只会有一个命令提示符的界面，类似

```bash
grub >
```

假如此时**优麒麟系统的启动文件没有损坏的话**，那么我们还能通过GRUB2命令行来启动操作系统。

在命令行模式下，我们能执行的命令十分有限，主要有

| 命令   | 描述                                                |
| ------ | --------------------------------------------------- |
| set    | 查看环境变量，这里可以查看启动路径和分区            |
| ls     | 查看设备                                            |
| insmod | 加载模块                                            |
| root   | 指定用于启动系统的分区,在救援模式下设置grub启动分区 |
| prefix | 设定grub启动路径                                    |

通过使用``ls``命令，可以列出磁盘中的所有分区

```
grub > (proc) (hd0) (hd0,gpt3) (hdo, gpt2) (hdo, gpt1) (hd1) (hd1,gpt4) (hd1, gpt3) (hd1, gpt2) (hd1, gpt1)
```

这里列出的是我的磁盘中的分区，不同的磁盘列出的结果可能不尽相同

通过``ls 设备名``可以区分是否优麒麟系统是否在对应设备上。如果在对应分区上则会提示``FileSystem type is ..., partition type ...``，否则则会提示``Unknown System type``或者``Unvalid File Name``。

找到了对应的设备之后可以通过``root``命令，指定用于启动系统的分区，例如在上面的例子中假设``/boot``所在的分区为``(hdo, gpt1)``,那么在grub命令行输入

```
grub > root(hdo,gpt1)
```

即可。

## GRUB2原理

如果细心观察过就会发现，在安装双系统的过程中，如果是先安装的Windows，再安装的Linux的话，在启动系统时可以选择是启动Linux还是启动Windows，但是如果安装的顺序相反则不会有这种现象。根据之前的资料我们知道系统启动需要读取MBR上面的信息，Linux通过GRUB2来引导。那么是不是和这两个东西有着什么关系呢？

答案是是的。

首先介绍一下什么叫**Boot Loader**。当系统启动开机自检完以后BIOS会把启动过程的控制权交给引导程序，而这个引导程序就是**Boot Loader**。不同的操作系统都有对应的**Boot Loader**，Windows的叫``ntldr``，Linux就是``GRUB2``。

那么这些**Boot Loader**都安装在什么地方呢，其实就是硬盘的MBR上。通过外设的**13号中断**，BIOS可以知道外设MBR的地址。对于windows，它要求一个主分区设置为活动分区，并把windows操作系统安装在该主分区。这个时候，windows的引导程序ntldr就会寻找到活动分区，并加载系统文件到内存。如果你的一块硬盘里有两个操作系统，一个是linux，一个是windows.那么如果ntldr安装在了MBR上，除非使用一些特定的工具进行额外配置，否则它是只能够启动windows的，ntldr不会把控制权交到别个系统的**Boot Loader**手上。而如果MBR上安装的是grub2，那么它就默认提供3大功能：

1. 提供一块硬盘上所有安装的系统的选择菜单；
2. 载入操作linux系统内核，移交控制权给内核；
3. 将控制权移交给其他系统的**Boot Loader**

也就是说在优麒麟系统启动时的选择菜单如果选择了Windows，那么GRUB2就会把控制权移交给Windows的**Boot Loader**，ntldr。

**Boot Loader**最主要的作用就是识别自己的操作系统文件，并将它载入到内存。那么新的问题出现了：一块硬盘只有一个MBR，在我们装上了grub2之后，就不能再装windows的ntldr了，如果没有ntldr就载入不了windows的系统文件，启动不了系统。但现在我们很多人的电脑上都有双系统，那是怎么做到的呢？

回到我们之前最开始提出的问题， 还是和安装系统的顺序有关系。每个分区都有一个引导扇区（boot sector）。那么当你把系统安装在某个分区时，它同时也会在该分区的boot sector上安装它自己的boot loader。因为一个分区只能装一个系统，这样该分区上的系统就可以被该分区的boot sector上的**Boot Loader**引导了，不会有其他系统的loader来抢占这个位置。但Windows除了在自己所在分区的boot sector上安装自己的**Boot Loader**，它还会在硬盘的MBR上也装上一份。所以，如果你先安装了linux，再装windows，那么最后MBR上就是ntldr，它是不会将控制权转交给别个系统的loader的，所以你也就启动不了linux。这也就解释了为什么我们的双系统安装要先安装Windows，再安装优麒麟或者是其他Linux发行版系统。
